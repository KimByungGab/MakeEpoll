# Epoll을 한번 만들어보자
이전에 IOCP를 만들고 해당 서버로 오목게임을 만들어봤는데 이번에는 번외편으로 Epoll을 만들어봤다.

분명 게임서버는 IOCP를 쓰는 곳이 압도적으로 많지만 상황은 모르는 법이기도 하고 코드적으로도 차이를 좀 더 느껴보고싶었다.(무엇보다 그냥 만들어보고 싶었던 것이 가장 크다. 궁금하잖아? 재밌을 것 같고 ㅋㅋ)

## IOCP를 만들 때와 달라진 점
1. 게임서버의 서비스를 분리하였다.<br>
   사실 이것은 당연하다고 생각할 수 있지만 IOCP를 만들 당시에는 PacketManager에서 다 처리하면 좋을 것 같아서 그렇게 진행했지만 네트워크와 게임로직을 좀 더 구분짓고싶었다.<br>
   때문에 다 만들고서 마지막에 PacketManager가 너무 God Object가 된 느낌이라서 조금 분리를 하고싶었다.
2. 나름대로 설정할 수 있는 파일을 만들어서 코드보다 파일로 설정을 할 수 있는 것을 만들었다.<br>
   조금이라도 더 관리를 할 때 용이하게 하고싶은데 이것을 어떻게 하면 좋을까 생각하다 ini파일을 만들어서 관리를 하는 것이 좋겠다 싶었다.<br>
   때문에 ini파일 등 각종 정적 라이브러리를 만들었다.
3. 실제 동작하는 네트워크를 라이브러리화 하여 각종 라이브러리를 만들었다.<br>
   만들었던 라이브러리는 총 4개. Epoll, ini 파싱, 데이터 직렬화/역직렬화, Singleton이다. 하지만 실제로 Singleton은 사용하지 않았다.<br>
   쓰지 않은 이유는 여러가지가 있지만 무엇보다 여기저기서 컨트롤을 할 수 있는 상황을 싫어했다.<br>
   일전에 다른 서버의 코드를 볼 때도 User 객체가 Manager단을 건드리고 했던 것으로 기억한다. 내 머릿속 서버의 생각은 User가 매니저의 존재를 아는 것을 싫어했기 때문에 이 구조를 어떻게든 지키고싶었다.<br>
   마치 2차원의 존재가 3차원을 몰라보는 것처럼 말이다.

## 프로젝트가 커질 경우 대략적인 구조
ServiceMain(게임서버의 객체, Epoll의 라이브러리를 상속받고 있다. 상속이유: 게임서버 객체가 Receive, Close, Connect를 재정의해서 쉽게 전달받기 위함.)<br>
├─ PacketManager(ServiceMain에서 Epoll 라이브러리로부터 재정의한 함수로부터 Packet을 관리.)<br>
  ├─ GameService(게임의 실질적인 비즈니스 로직. 게임의 모든 로직을 여기서 진행.)<br>
    ├─UserManager(도메인 객체 매니저. 게임에 필요한 객체들을 관리하는 역할. 단순히 관리의 역할만 할 뿐.)<br>
      ├─User(도메인 객체. 실질적으로 게임에서 돌아갈 때 사용되는 진짜 객체들.)<br>
    ├─지금은 없지만 각종 게임에 필요한 매니저들(ex. ZoneManager 등)

## 느낀 점
IOCP와 전체적으로 여러가지 많이 다른 부분이 있었다.<br>
IOCP에서는 IOCP 내부에서 원하는 네트워크 쓰레드 하나를 깨워서 처리할 수 있게 진행했다. 때문에 네트워크 코어 코드를 만질 때 단일쓰레드처럼 생각을 했었다.<br>
반면 Epoll은 직접 만들어서 사용해봤을 때 기다리고 있던 모든 쓰레드가 일제히 일어나는 과정을 보기도 하였다. 때문에 로드밸런서는 아니지만 등록하는 Epoll의 분배도 나누기도 하는 등 나름대로 갖은 생각을 하면서 이것저것 만들었다.

이 서버를 만들면서 여러가지 시도를 해보았던 것 같다.

세션(해당 코드에선 Client)을 안 넣으면 어떤 점이 곤란해질까?<br>
만약 Client가 실질적인 네트워크 recv, send를 가지고 있다면 어떤 점이 달라질까?<br>
실질적인 로직은 객체가 처리하는것이 정말 좋은걸까 아니면 서비스같은 로직전문 처리 객체를 하나 마련하는것이 좋을까?<br>
싱글톤을 사용해서 각 매니저를 어디서든지 접근하게 하는 것이 정말 좋을까? 쉽게 처리할 수 있지만 이것만큼은 진짜 아닌 것 같은데?

정말 다양한 생각을 하면서 하나하나 손수 만들어보았다. 서버를 만들면 만들수록 더 생각을 하는 것이 더욱 다음에 게임을 만들 때는 어떤 것을 할 지 고민을 하는 것 같아 기분이 좋다.<br>

## 향후 무엇을 할까?
2가지를 염두에 두고 있다.

1. boost를 이용해서 현재 Epoll과 같은 기본 로직을 만들기
2. 현재 이 Epoll로 간단한 2D RPG? 간단한 동물의 숲 같은 거라도?? 만들어보기

무엇을 할 지 생각을 하면서 회고는 여기서 마치고자 한다.
